#!/usr/bin/bash

# called by dracut
check() {
    [[ "$mount_needs" ]] && return 1
    [[ $(pkglib_dir) ]] || return 1

    require_binaries @cagebinaryname@ foot || return 1

    return 0
}

# called by dracut
depends() {
    echo drm
}

# called by dracut
install() {
    if [ -z "$LOCALE_LIB_DIR" ]
    then
        LOCALE_LIB_DIR=/usr/lib/locale
    fi

    if [ -z "$LIBINPUT_SHARE_DIR" ]
    then
        LIBINPUT_SHARE_DIR=/usr/share/libinput
    fi

    if [ -z "$LIBX11_SHARE_DIR" ]
    then
        LIBX11_SHARE_DIR=/usr/share/X11
    fi

    inst_simple "@bindir@/recinit" /usr/bin/recinit
    inst_multiple @cagebinaryname@ foot id kanshi tput pkill
    instmods evdev

    inst_rules 60-input-id.rules

    MonospaceFontPath=$(fc-match -f %{file} monospace)
    if [ -n "$MonospaceFontPath" ]
    then
        inst_simple "$MonospaceFontPath" 
    fi

    BoldMonospaceFontPath=$(fc-match -f %{file} monospace:weight=bold)
    if [ -n "$BoldMonospaceFontPath" ]
    then
        inst_simple "$BoldMonospaceFontPath"
    fi

    if [ -e "$LOCALE_LIB_DIR"/[cC].[uU][tT][fF]*8/ ]
    then
        CUTF8DIR=$(basename $(ls -d "$LOCALE_LIB_DIR"/[cC].[uU][tT][fF]*8))
        find "$LOCALE_LIB_DIR/$CUTF8DIR" ! -type d | while read -r file
        do
            inst_simple "$file"
        done
    fi

    if [ -e "$LIBINPUT_SHARE_DIR" ]
    then
        find "$LIBINPUT_SHARE_DIR" ! -type d | while read -r file
        do
            inst_simple "$file"
        done
    fi

    if [ -e "$LIBX11_SHARE_DIR/xkb" ]
    then
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/accessx"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/basic"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/caps"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/complete"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/iso9995"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/ledcaps"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/lednum"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/ledscroll"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/level5"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/misc"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/mousekeys"
        inst_simple "$LIBX11_SHARE_DIR/xkb/compat/xfree86"
        inst_simple "$LIBX11_SHARE_DIR/xkb/keycodes/aliases"
        inst_simple "$LIBX11_SHARE_DIR/xkb/keycodes/evdev"
        inst_simple "$LIBX11_SHARE_DIR/xkb/rules/evdev"
        find "$LIBX11_SHARE_DIR/xkb/symbols" -maxdepth 1 ! -type d | while read -r file
        do
            inst_simple "$file"
        done
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/basic"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/complete"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/extra"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/iso9995"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/level5"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/mousekeys"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/numpad"
        inst_simple "$LIBX11_SHARE_DIR/xkb/types/pc"
    fi

    if [ -e "$LIBX11_SHARE_DIR/locale" ]
    then
        # In the off chance the user uses their compose key in initrd
        if [ -f "$LIBX11_SHARE_DIR/locale/compose.dir" ]
        then
            inst_simple "$LIBX11_SHARE_DIR/locale/compose.dir"
            grep UTF-8/Compose: "$LIBX11_SHARE_DIR/locale/compose.dir" | awk -F: '{ print $1 }' | sort -u | xargs dirname | while read -r DIR
            do
                find "$LIBX11_SHARE_DIR/locale/$DIR" -maxdepth 1 ! -type d | while read -r file
                do
                    inst_simple "$file"
                done
            done
        fi
    fi

    if [ -e "@sysconfdir@/vtty" ]
    then
        mkdir -p "$initdir/@sysconfdir@/vtty"
        cp -a "@sysconfdir@/vtty/"* "$initdir/@sysconfdir@/vtty"
    fi

    inst_simple "@systemdsystemunitdir@/recinit-emergency.service"
    inst_simple "@systemdsystemunitdir@/emergency.target.wants/recinit-emergency.service"
    inst_simple "@systemdsystemunitdir@/recinit-rescue.service"
    inst_simple "@systemdsystemunitdir@/rescue.target.service/recinit-rescue.service"

    inst_simple "$moddir/recinit-dracut-emergency" "/usr/bin/recinit-dracut-emergency"
    inst_simple "$moddir/dracut-lib-recinit-shell.sh" "/lib/dracut-lib-recinit-shell.sh"
    echo ". /lib/dracut-lib-recinit-shell.sh" >> "$initdir/lib/dracut-lib.sh"
}
