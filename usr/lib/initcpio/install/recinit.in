#!/usr/bin/bash

build() {

    if [ -z "$LOCALE_LIB_DIR" ]
    then
        LOCALE_LIB_DIR=/usr/lib/locale
    fi

    if [ -z "$LIBINPUT_SHARE_DIR" ]
    then
        LIBINPUT_SHARE_DIR=/usr/share/libinput
    fi

    if [ -z "$LIBX11_SHARE_DIR" ]
    then
        LIBX11_SHARE_DIR=/usr/share/X11
    fi

    add_binary @cagebinaryname@
    add_binary foot
    add_binary kanshi
    add_file "@bindir@/recinit" /usr/bin/recinit
    add_binary id
    add_binary tput
    add_binary pkill

    add_module evdev
    add_udev_rule /lib/udev/rules.d/60-input-id.rules

    MonospaceFontPath=$(fc-match -f %{file} monospace)
    if [ -n "$MonospaceFontPath" ]
    then
        add_file "$MonospaceFontPath"
    fi

    BoldMonospaceFontPath=$(fc-match -f %{file} monospace:weight=bold)
    if [ -n "$BoldMonospaceFontPath" ]
    then
        add_file "$BoldMonospaceFontPath"
    fi

    if [ -e $LOCALE_LIB_DIR/[cC].[uU][tT][fF]*8/ ]
    then
        CUTF8DIR=$(basename $(ls -d "$LOCALE_LIB_DIR"/[cC].[uU][tT][fF]*8))
        add_full_dir "$LOCALE_LIB_DIR/$CTUF8DIR"
    fi

    if [ -e "$LIBINPUT_SHARE_DIR" ]
    then
        add_full_dir "$LIBINPUT_SHARE_DIR"
    fi

    if [ -e "$LIBX11_SHARE_DIR/xkb" ]
    then
        add_file "$LIBX11_SHARE_DIR/xkb/compat/accessx"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/basic"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/caps"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/complete"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/iso9995"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/ledcaps"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/lednum"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/ledscroll"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/level5"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/misc"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/mousekeys"
        add_file "$LIBX11_SHARE_DIR/xkb/compat/xfree86"
        add_file "$LIBX11_SHARE_DIR/xkb/keycodes/aliases"
        add_file "$LIBX11_SHARE_DIR/xkb/keycodes/evdev"
        add_file "$LIBX11_SHARE_DIR/xkb/rules/evdev"
        find "$LIBX11_SHARE_DIR/xkb/symbols" -maxdepth 1 ! -type d | while read -r file
        do
            add_file "$file"
        done
        add_file "$LIBX11_SHARE_DIR/xkb/types/basic"
        add_file "$LIBX11_SHARE_DIR/xkb/types/complete"
        add_file "$LIBX11_SHARE_DIR/xkb/types/extra"
        add_file "$LIBX11_SHARE_DIR/xkb/types/iso9995"
        add_file "$LIBX11_SHARE_DIR/xkb/types/level5"
        add_file "$LIBX11_SHARE_DIR/xkb/types/mousekeys"
        add_file "$LIBX11_SHARE_DIR/xkb/types/numpad"
        add_file "$LIBX11_SHARE_DIR/xkb/types/pc"
    fi

    if [ -e "$LIBX11_SHARE_DIR/locale" ]
    then
        # In the off chance the user uses their compose key in initrd
        if [ -f "$LIBX11_SHARE_DIR/locale/compose.dir" ]
        then
            add_file "$LIBX11_SHARE_DIR/locale/compose.dir"
            grep UTF-8/Compose: "$LIBX11_SHARE_DIR/locale/compose.dir" | awk -F: '{ print $1 }' | sort -u | xargs dirname | while read -r DIR
            do
                find "$LIBX11_SHARE_DIR/locale/$DIR" -maxdepth 1 ! -type d | while read -r file
                do
                    add_file "$file"
                done
            done
        fi
    fi

    if [ -e "@sysconfdir@/vtty" ]
    then
        add_full_dir "@sysconfdir@/vtty"
    fi

    if declare -F add_systemd_unit &> /dev/null
    then
        add_systemd_unit recinit-emergency.service
    fi

    add_file "@mkinitcpiodir@/override/init_functions_override" "/init_functions_override"
    echo ". /init_functions_override" >> "$BUILDROOT/init_functions"
}

help() {
    echo "Copies files needed for running recinit into initcpio"
}
